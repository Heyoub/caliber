---
/**
 * Login Page
 * Redirects to WorkOS SSO authorization endpoint
 * Supports optional organization and login_hint query params
 */
import Layout from '../layouts/Layout.astro';

// Get API URL from environment
const apiUrl = import.meta.env.PUBLIC_API_URL || 'https://api.caliber.run';
---

<Layout title="Login - CALIBER">
  <main class="min-h-screen flex items-center justify-center px-4 py-16">
    <div class="w-full max-w-md">
      <!-- Logo -->
      <div class="text-center mb-8">
        <a href="/" class="inline-block">
          <span class="text-3xl font-bold font-title">
            <span class="text-text-primary">CALI</span><span class="neon-text-purple">BER</span>
          </span>
        </a>
        <p class="text-text-secondary mt-2">Memory for AI Agents</p>
      </div>

      <!-- Login Card -->
      <div class="bg-bg-card border-2 border-border brutalist-box p-8">
        <h1 class="text-2xl font-bold font-title text-text-primary mb-6 text-center">
          Sign in to CALIBER
        </h1>

        <!-- Loading state -->
        <div id="loading-state" class="hidden">
          <div class="flex flex-col items-center gap-4 py-8">
            <div class="w-8 h-8 border-2 border-neon-purple border-t-transparent rounded-full animate-spin"></div>
            <p class="text-text-secondary">Redirecting to login...</p>
          </div>
        </div>

        <!-- Login form -->
        <div id="login-form">
          <!-- SSO Button -->
          <button
            id="sso-button"
            type="button"
            class="w-full py-4 bg-neon-purple/20 border-2 border-neon-purple text-text-primary font-semibold brutalist-box hover:bg-neon-purple/30 transition-colors flex items-center justify-center gap-3"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
            </svg>
            Continue with SSO
          </button>

          <!-- Divider -->
          <div class="relative my-6">
            <div class="absolute inset-0 flex items-center">
              <div class="w-full border-t border-border"></div>
            </div>
            <div class="relative flex justify-center text-sm">
              <span class="bg-bg-card px-4 text-text-muted">or</span>
            </div>
          </div>

          <!-- Email input for login hint -->
          <form id="email-form" class="space-y-4">
            <div>
              <label for="email" class="block text-sm font-medium text-text-secondary mb-2">
                Email address
              </label>
              <input
                type="email"
                id="email"
                name="email"
                placeholder="you@company.com"
                class="w-full px-4 py-3 bg-bg-secondary border-2 border-border text-text-primary placeholder-text-muted focus:border-neon-purple focus:outline-none brutalist-box-sm"
              />
            </div>
            <button
              type="submit"
              class="w-full py-4 bg-bg-secondary border-2 border-border text-text-primary font-semibold brutalist-box hover:border-neon-cyan transition-colors"
            >
              Continue with Email
            </button>
          </form>

          <!-- Error message -->
          <div id="error-message" class="hidden mt-4 p-4 bg-red-500/10 border border-red-500/30 text-red-400 text-sm">
          </div>
        </div>

        <!-- Footer -->
        <p class="mt-6 text-center text-text-muted text-sm">
          Don't have an account?
          <a href="/#pricing" class="text-neon-cyan hover:text-neon-pink">Start free trial</a>
        </p>
      </div>

      <!-- Back link -->
      <div class="text-center mt-6">
        <a href="/" class="text-text-muted hover:text-text-secondary text-sm">
          &larr; Back to home
        </a>
      </div>
    </div>
  </main>
</Layout>

<script define:vars={{ apiUrl }}>
  // Check if already authenticated
  const token = localStorage.getItem('caliber_token');
  if (token) {
    try {
      const payload = JSON.parse(atob(token.split('.')[1]));
      const now = Math.floor(Date.now() / 1000);
      if (payload.exp > now) {
        // Already authenticated, redirect to dashboard
        window.location.href = '/dashboard';
      }
    } catch (e) {
      // Invalid token, clear it
      localStorage.removeItem('caliber_token');
      localStorage.removeItem('caliber_user');
    }
  }

  // Get return URL from query params
  const urlParams = new URLSearchParams(window.location.search);
  const returnUrl = urlParams.get('return_url') || '/dashboard';

  // Store return URL for after auth
  sessionStorage.setItem('caliber_return_url', returnUrl);

  // DOM elements
  const loadingState = document.getElementById('loading-state');
  const loginForm = document.getElementById('login-form');
  const ssoButton = document.getElementById('sso-button');
  const emailForm = document.getElementById('email-form');
  const errorMessage = document.getElementById('error-message');

  // Show loading state
  function showLoading() {
    loadingState?.classList.remove('hidden');
    loginForm?.classList.add('hidden');
  }

  // Show error
  function showError(message) {
    if (errorMessage) {
      errorMessage.textContent = message;
      errorMessage.classList.remove('hidden');
    }
  }

  // Redirect to WorkOS SSO
  function redirectToSSO(email) {
    showLoading();

    const authUrl = new URL('/auth/sso/authorize', apiUrl);
    authUrl.searchParams.set('redirect_uri', `${window.location.origin}/auth/callback`);

    if (email) {
      authUrl.searchParams.set('login_hint', email);
    }

    window.location.href = authUrl.toString();
  }

  // SSO button click
  ssoButton?.addEventListener('click', () => {
    redirectToSSO();
  });

  // Email form submit
  emailForm?.addEventListener('submit', (e) => {
    e.preventDefault();
    const email = document.getElementById('email')?.value;
    if (email) {
      redirectToSSO(email);
    } else {
      showError('Please enter your email address');
    }
  });

  // Check for error in URL (from failed callback)
  const errorParam = urlParams.get('error');
  if (errorParam) {
    showError(urlParams.get('error_description') || errorParam);
  }
</script>
