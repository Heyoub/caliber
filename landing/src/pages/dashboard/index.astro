---
/**
 * Dashboard Overview Page
 * Shows high-level metrics and quick actions
 */
import DashboardLayout from '../../layouts/DashboardLayout.astro';
---

<DashboardLayout title="Dashboard - CALIBER">
  <!-- Page header -->
  <div class="mb-8">
    <h1 class="text-2xl sm:text-3xl font-bold font-title text-text-primary">
      Dashboard
    </h1>
    <p class="text-text-secondary mt-1">
      Welcome to CALIBER Cloud. Monitor your AI agent memory.
    </p>
  </div>

  <!-- Stats cards -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
    <!-- Trajectories -->
    <div class="bg-bg-card border-2 border-border brutalist-box p-5">
      <div class="flex items-center gap-3 mb-3">
        <div class="w-10 h-10 bg-neon-purple/10 border border-neon-purple/30 flex items-center justify-center">
          <svg class="w-5 h-5 text-neon-purple" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
        </div>
        <span class="text-text-muted text-sm font-medium">Trajectories</span>
      </div>
      <p id="stat-trajectories" class="text-3xl font-bold font-title text-text-primary">-</p>
      <p class="text-text-muted text-xs mt-1">Active memory contexts</p>
    </div>

    <!-- Scopes -->
    <div class="bg-bg-card border-2 border-border brutalist-box p-5">
      <div class="flex items-center gap-3 mb-3">
        <div class="w-10 h-10 bg-neon-cyan/10 border border-neon-cyan/30 flex items-center justify-center">
          <svg class="w-5 h-5 text-neon-cyan" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
          </svg>
        </div>
        <span class="text-text-muted text-sm font-medium">Scopes</span>
      </div>
      <p id="stat-scopes" class="text-3xl font-bold font-title text-text-primary">-</p>
      <p class="text-text-muted text-xs mt-1">Memory partitions</p>
    </div>

    <!-- Storage -->
    <div class="bg-bg-card border-2 border-border brutalist-box p-5">
      <div class="flex items-center gap-3 mb-3">
        <div class="w-10 h-10 bg-neon-pink/10 border border-neon-pink/30 flex items-center justify-center">
          <svg class="w-5 h-5 text-neon-pink" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" />
          </svg>
        </div>
        <span class="text-text-muted text-sm font-medium">Storage</span>
      </div>
      <p id="stat-storage" class="text-3xl font-bold font-title text-text-primary">-</p>
      <p class="text-text-muted text-xs mt-1">Of your quota used</p>
    </div>

    <!-- Status -->
    <div class="bg-bg-card border-2 border-border brutalist-box p-5">
      <div class="flex items-center gap-3 mb-3">
        <div class="w-10 h-10 bg-green-500/10 border border-green-500/30 flex items-center justify-center">
          <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <span class="text-text-muted text-sm font-medium">Status</span>
      </div>
      <p id="stat-status" class="text-3xl font-bold font-title text-green-400">Active</p>
      <p id="stat-plan" class="text-text-muted text-xs mt-1">Trial</p>
    </div>
  </div>

  <!-- Quick actions & Recent activity -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Quick actions -->
    <div class="bg-bg-card border-2 border-border brutalist-box p-6">
      <h2 class="text-lg font-bold font-title text-text-primary mb-4">Quick Actions</h2>
      <div class="space-y-3">
        <a
          href="/dashboard/trajectories"
          class="flex items-center gap-3 p-3 bg-bg-secondary border border-border hover:border-neon-purple/50 transition-colors"
        >
          <div class="w-8 h-8 bg-neon-purple/10 flex items-center justify-center">
            <svg class="w-4 h-4 text-neon-purple" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
            </svg>
          </div>
          <div>
            <p class="text-sm font-medium text-text-primary">View Trajectories</p>
            <p class="text-xs text-text-muted">Browse all memory contexts</p>
          </div>
        </a>
        <a
          href="/dashboard/settings"
          class="flex items-center gap-3 p-3 bg-bg-secondary border border-border hover:border-neon-cyan/50 transition-colors"
        >
          <div class="w-8 h-8 bg-neon-cyan/10 flex items-center justify-center">
            <svg class="w-4 h-4 text-neon-cyan" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
            </svg>
          </div>
          <div>
            <p class="text-sm font-medium text-text-primary">Get API Key</p>
            <p class="text-xs text-text-muted">Configure your agents</p>
          </div>
        </a>
        <a
          href="https://docs.caliber.run"
          target="_blank"
          rel="noopener noreferrer"
          class="flex items-center gap-3 p-3 bg-bg-secondary border border-border hover:border-neon-pink/50 transition-colors"
        >
          <div class="w-8 h-8 bg-neon-pink/10 flex items-center justify-center">
            <svg class="w-4 h-4 text-neon-pink" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
            </svg>
          </div>
          <div>
            <p class="text-sm font-medium text-text-primary">Documentation</p>
            <p class="text-xs text-text-muted">Learn how to use CALIBER</p>
          </div>
        </a>
      </div>
    </div>

    <!-- Getting started -->
    <div class="bg-bg-card border-2 border-border brutalist-box p-6">
      <h2 class="text-lg font-bold font-title text-text-primary mb-4">Getting Started</h2>
      <div class="space-y-4">
        <div class="flex items-start gap-3">
          <div class="w-6 h-6 bg-neon-purple/20 border border-neon-purple/30 flex items-center justify-center text-xs font-bold text-neon-purple flex-shrink-0">
            1
          </div>
          <div>
            <p class="text-sm font-medium text-text-primary">Get your API key</p>
            <p class="text-xs text-text-muted">Visit Settings to copy your API key</p>
          </div>
        </div>
        <div class="flex items-start gap-3">
          <div class="w-6 h-6 bg-neon-cyan/20 border border-neon-cyan/30 flex items-center justify-center text-xs font-bold text-neon-cyan flex-shrink-0">
            2
          </div>
          <div>
            <p class="text-sm font-medium text-text-primary">Install the SDK</p>
            <p class="text-xs text-text-muted font-mono bg-bg-secondary px-2 py-1 mt-1 inline-block">npm install @caliber/sdk</p>
          </div>
        </div>
        <div class="flex items-start gap-3">
          <div class="w-6 h-6 bg-neon-pink/20 border border-neon-pink/30 flex items-center justify-center text-xs font-bold text-neon-pink flex-shrink-0">
            3
          </div>
          <div>
            <p class="text-sm font-medium text-text-primary">Create a trajectory</p>
            <p class="text-xs text-text-muted">Start logging agent memory</p>
          </div>
        </div>
      </div>
      <div class="mt-6 p-4 bg-bg-secondary border border-border">
        <pre class="text-xs text-text-secondary overflow-x-auto"><code>import { CaliberClient } from '@caliber/sdk';

const caliber = new CaliberClient({
  apiKey: 'your-api-key',
});

const trajectory = await caliber.trajectories.create({
  name: 'my-agent-session',
});</code></pre>
      </div>
    </div>
  </div>
</DashboardLayout>

<script>
  const API_URL = import.meta.env.PUBLIC_API_URL || 'https://api.caliber.run';

  async function loadStats() {
    const token = localStorage.getItem('caliber_token');
    if (!token) return;

    try {
      // Fetch trajectories count
      const trajResponse = await fetch(`${API_URL}/api/v1/trajectories?limit=1`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      if (trajResponse.ok) {
        const data = await trajResponse.json();
        const trajEl = document.getElementById('stat-trajectories');
        if (trajEl) trajEl.textContent = data.meta?.total?.toString() || '0';
      }

      // Fetch billing status
      const billingResponse = await fetch(`${API_URL}/api/v1/billing/status`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      if (billingResponse.ok) {
        const billing = await billingResponse.json();

        // Update storage stat
        const storageEl = document.getElementById('stat-storage');
        if (storageEl && billing.storage_used_bytes !== undefined) {
          const usedMB = (billing.storage_used_bytes / 1024 / 1024).toFixed(1);
          storageEl.textContent = `${usedMB} MB`;
        }

        // Update plan
        const planEl = document.getElementById('stat-plan');
        if (planEl && billing.plan) {
          planEl.textContent = billing.plan.charAt(0).toUpperCase() + billing.plan.slice(1);
        }
      }
    } catch (e) {
      console.error('Failed to load stats:', e);
    }
  }

  loadStats();
</script>
