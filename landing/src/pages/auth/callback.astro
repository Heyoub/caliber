---
/**
 * Auth Callback Page
 * Handles the OAuth callback from WorkOS
 * Stores JWT and redirects to dashboard
 */
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Authenticating... - CALIBER">
  <main class="min-h-screen flex items-center justify-center px-4 py-16">
    <div class="w-full max-w-md text-center">
      <!-- Loading state -->
      <div id="loading-state">
        <div class="flex flex-col items-center gap-4">
          <div class="w-12 h-12 border-3 border-neon-purple border-t-transparent rounded-full animate-spin"></div>
          <h1 class="text-xl font-bold font-title text-text-primary">
            Completing sign in...
          </h1>
          <p class="text-text-secondary">
            Please wait while we authenticate your session.
          </p>
        </div>
      </div>

      <!-- Error state -->
      <div id="error-state" class="hidden">
        <div class="bg-bg-card border-2 border-red-500/50 brutalist-box p-8">
          <div class="w-16 h-16 mx-auto mb-4 flex items-center justify-center bg-red-500/10 border border-red-500/30 rounded-full">
            <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </div>
          <h1 class="text-xl font-bold font-title text-text-primary mb-2">
            Authentication Failed
          </h1>
          <p id="error-message" class="text-red-400 mb-6">
            An error occurred during sign in.
          </p>
          <a
            href="/login"
            class="inline-block px-6 py-3 bg-bg-secondary border-2 border-border text-text-primary font-semibold brutalist-box hover:border-neon-cyan transition-colors"
          >
            Try Again
          </a>
        </div>
      </div>

      <!-- Success state (brief flash before redirect) -->
      <div id="success-state" class="hidden">
        <div class="flex flex-col items-center gap-4">
          <div class="w-16 h-16 flex items-center justify-center bg-neon-cyan/10 border border-neon-cyan/30 rounded-full">
            <svg class="w-8 h-8 text-neon-cyan" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
          </div>
          <h1 class="text-xl font-bold font-title text-text-primary">
            Welcome back!
          </h1>
          <p class="text-text-secondary">
            Redirecting to dashboard...
          </p>
        </div>
      </div>
    </div>
  </main>
</Layout>

<script>
  // DOM elements
  const loadingState = document.getElementById('loading-state');
  const errorState = document.getElementById('error-state');
  const successState = document.getElementById('success-state');
  const errorMessage = document.getElementById('error-message');

  function showError(message: string) {
    loadingState?.classList.add('hidden');
    successState?.classList.add('hidden');
    errorState?.classList.remove('hidden');
    if (errorMessage) {
      errorMessage.textContent = message;
    }
  }

  function showSuccess() {
    loadingState?.classList.add('hidden');
    errorState?.classList.add('hidden');
    successState?.classList.remove('hidden');
  }

  function handleCallback() {
    const params = new URLSearchParams(window.location.search);

    // Check for error from WorkOS or API
    const error = params.get('error');
    if (error) {
      const description = params.get('error_description') || error;
      showError(description);
      return;
    }

    // Get token from URL (API redirects with token in query param)
    const token = params.get('token');
    if (!token) {
      showError('No authentication token received. Please try again.');
      return;
    }

    // Validate and parse token
    try {
      const payload = JSON.parse(atob(token.split('.')[1]));

      // Check expiration
      const now = Math.floor(Date.now() / 1000);
      if (payload.exp <= now) {
        showError('Authentication token has expired. Please try again.');
        return;
      }

      // Extract user info
      const user = {
        id: payload.user_id,
        email: payload.email,
        firstName: payload.first_name,
        lastName: payload.last_name,
        tenantId: payload.organization_id,
      };

      // Store in localStorage
      localStorage.setItem('caliber_token', token);
      localStorage.setItem('caliber_user', JSON.stringify(user));

      // Show success state
      showSuccess();

      // Get return URL from session storage
      const returnUrl = sessionStorage.getItem('caliber_return_url') || '/dashboard';
      sessionStorage.removeItem('caliber_return_url');

      // Redirect after brief delay
      setTimeout(() => {
        window.location.href = returnUrl;
      }, 500);

    } catch (e) {
      showError('Invalid authentication token. Please try again.');
    }
  }

  // Process callback on page load
  handleCallback();
</script>
