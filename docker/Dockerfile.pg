# CALIBER PostgreSQL with pgrx Extension
# PostgreSQL 18 with caliber-pg extension pre-installed
#
# BREAKING CHANGE (v0.4.0): CALIBER now requires PostgreSQL 18+
#
# Usage:
#   docker build -f docker/Dockerfile.pg -t caliber-pg .

# Stage 1: Build extension
FROM rust:1.85-bookworm AS builder

WORKDIR /build

# Add PostgreSQL 18 APT repository
RUN apt-get update && apt-get install -y wget gnupg lsb-release \
    && echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list \
    && wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add -

# Install pgrx dependencies and PostgreSQL 18 dev packages
RUN apt-get update && apt-get install -y \
    pkg-config \
    libssl-dev \
    libclang-dev \
    clang \
    postgresql-server-dev-18 \
    postgresql-18 \
    && rm -rf /var/lib/apt/lists/*

# Install pgrx
RUN cargo install cargo-pgrx --version 0.16.1 --locked
RUN cargo pgrx init --pg18 /usr/lib/postgresql/18/bin/pg_config

# Copy workspace files
COPY Cargo.toml Cargo.lock ./
COPY caliber-core ./caliber-core
COPY caliber-storage ./caliber-storage
COPY caliber-context ./caliber-context
COPY caliber-pcp ./caliber-pcp
COPY caliber-llm ./caliber-llm
COPY caliber-agents ./caliber-agents
COPY caliber-dsl ./caliber-dsl
COPY caliber-pg ./caliber-pg
COPY caliber-api ./caliber-api
COPY caliber-test-utils ./caliber-test-utils
COPY caliber-tui ./caliber-tui

# Remove pgrx git patches for extension build (use crates.io release)
RUN sed -i '/^\[patch\.crates-io\]/,$d' Cargo.toml

# Install extension directly to PostgreSQL in builder
RUN cd caliber-pg && cargo pgrx install --pg-config /usr/lib/postgresql/18/bin/pg_config --features pg18 --release

# WORKAROUND: pgrx 0.16 doesn't generate SQL file properly
# Manually copy the bootstrap SQL as the extension installation script
RUN cp /build/caliber-pg/sql/caliber_init.sql /usr/share/postgresql/18/extension/caliber_pg--0.4.0.sql

# Debug: Show installed extension files
RUN echo "=== Installed extension files ===" && ls -la /usr/share/postgresql/18/extension/caliber*

# Stage 2: Runtime
FROM postgres:18-bookworm

# Install pgvector extension (required for embedding columns)
RUN apt-get update && apt-get install -y postgresql-18-pgvector && rm -rf /var/lib/apt/lists/*

# Copy extension files from builder's PostgreSQL installation
COPY --from=builder /usr/share/postgresql/18/extension/caliber* /usr/share/postgresql/18/extension/
COPY --from=builder /usr/lib/postgresql/18/lib/caliber* /usr/lib/postgresql/18/lib/

# Copy initialization script
COPY docker/init-caliber.sh /docker-entrypoint-initdb.d/01-init-caliber.sh
RUN chmod +x /docker-entrypoint-initdb.d/01-init-caliber.sh

# Note: Do NOT add shared_preload_libraries here - it causes initdb to fail
# because it tries to load the extension before the database cluster exists.
# The extension is loaded via CREATE EXTENSION in init-caliber.sh instead.

EXPOSE 5432
