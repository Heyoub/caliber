/**
 * Penetration Test: Mass Assignment
 */

import { describe, expect, it } from 'bun:test';

const API_BASE_URL = process.env.CALIBER_API_URL ?? 'http://localhost:3000';
const SKIP = process.env.SKIP_SECURITY_TESTS === 'true';

async function api(method: string, path: string, body?: unknown): Promise<Response> {
  const url = `${API_BASE_URL}${path}`;
  const options: RequestInit = {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: body ? JSON.stringify(body) : undefined,
  };
  return fetch(url, options);
}

describe.skipIf(SKIP)('pentest: mass assignment', () => {
  it('does not allow overriding protected fields on create', async () => {
    const res = await api('POST', '/api/v1/trajectories', {
      name: 'mass-assignment-test',
      status: 'completed',
      tenant_id: '00000000-0000-0000-0000-000000000000',
      created_at: '1970-01-01T00:00:00Z',
    });

    expect(res.status).not.toBe(500);

    const text = await res.text();
    expect(text.toLowerCase()).not.toContain('panic');
  });
});
