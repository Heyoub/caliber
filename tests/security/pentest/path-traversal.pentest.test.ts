/**
 * Penetration Test: Path Traversal / LFI
 */

import { describe, expect, it } from 'bun:test';

const API_BASE_URL = process.env.CALIBER_API_URL ?? 'http://localhost:3000';
const SKIP = process.env.SKIP_SECURITY_TESTS === 'true';

const PAYLOADS = [
  '../../../etc/passwd',
  '..%2f..%2f..%2fetc%2fpasswd',
  '....//....//....//etc/passwd',
  '..\\..\\..\\windows\\system32\\config\\sam',
];

describe.skipIf(SKIP)('pentest: path traversal', () => {
  it('does not serve files via path parameters', async () => {
    for (const payload of PAYLOADS) {
      const res = await fetch(
        `${API_BASE_URL}/api/v1/artifacts/${encodeURIComponent(payload)}`
      );
      expect(res.status).not.toBe(200);
      expect(res.status).not.toBe(500);
    }
  });

  it('does not allow traversal in query parameters', async () => {
    for (const payload of PAYLOADS) {
      const res = await fetch(
        `${API_BASE_URL}/api/v1/search?path=${encodeURIComponent(payload)}`
      );
      expect(res.status).not.toBe(200);
      expect(res.status).not.toBe(500);
    }
  });
});
