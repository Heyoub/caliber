/**
 * Penetration Test: SSRF protections
 */

import { describe, expect, it } from 'bun:test';

const API_BASE_URL = process.env.CALIBER_API_URL ?? 'http://localhost:3000';
const SKIP = process.env.SKIP_SECURITY_TESTS === 'true';

const SSRF_URLS = [
  'http://169.254.169.254/latest/meta-data/',
  'http://localhost:22',
  'file:///etc/passwd',
];

async function api(url: string): Promise<Response> {
  return fetch(`${API_BASE_URL}/api/v1/webhooks`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      name: 'ssrf-test',
      url,
      events: ['trajectory.created'],
    }),
  });
}

describe.skipIf(SKIP)('pentest: SSRF', () => {
  it('rejects internal/unsafe URLs for webhooks', async () => {
    for (const url of SSRF_URLS) {
      const res = await api(url);
      expect(res.status).not.toBe(500);
      expect(res.status).not.toBe(200);
    }
  });
});
