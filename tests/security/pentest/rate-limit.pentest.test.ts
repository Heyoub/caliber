/**
 * Penetration Test: Rate Limiting
 */

import { describe, expect, it, beforeAll } from 'bun:test';
import { clearRateLimits, isUsingMocks } from '../../mocks/server';

const API_BASE_URL = process.env.CALIBER_API_URL ?? 'http://localhost:3000';
const SKIP = process.env.SKIP_SECURITY_TESTS === 'true';

beforeAll(() => {
  clearRateLimits();
});

describe.skipIf(SKIP)('pentest: rate limiting', () => {
  it('enforces rate limit on auth endpoints', async () => {
    const requests = [] as Promise<Response>[];

    for (let i = 0; i < 25; i++) {
      requests.push(
        fetch(`${API_BASE_URL}/api/v1/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: 'bad', password: 'bad' }),
        })
      );
    }

    const responses = await Promise.all(requests);
    const statuses = responses.map((r) => r.status);

    if (isUsingMocks()) {
      expect(statuses).toContain(429);
    } else {
      // Live server may rate limit differently, but should not 500.
      expect(statuses.some((s) => s === 500)).toBe(false);
    }
  });
});
