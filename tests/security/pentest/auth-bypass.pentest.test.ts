/**
 * Penetration Test: Auth Bypass
 */

import { describe, expect, it } from 'bun:test';

const API_BASE_URL = process.env.CALIBER_API_URL ?? 'http://localhost:3000';
const SKIP = process.env.SKIP_SECURITY_TESTS === 'true';

async function api(path: string, headers?: Record<string, string>): Promise<Response> {
  return fetch(`${API_BASE_URL}${path}`, { headers });
}

describe.skipIf(SKIP)('pentest: auth bypass', () => {
  it('rejects requests without auth', async () => {
    const res = await api('/api/v1/trajectories');
    expect([401, 403]).toContain(res.status);
  });

  it('rejects malformed bearer tokens', async () => {
    const res = await api('/api/v1/trajectories', {
      Authorization: 'Bearer invalid.token',
    });
    expect([401, 403]).toContain(res.status);
  });

  it('rejects algorithm confusion (none)', async () => {
    const res = await api('/api/v1/trajectories', {
      Authorization: 'Bearer eyJhbGciOiJub25lIn0.eyJzdWIiOiJ0ZXN0In0.',
    });
    expect([401, 403]).toContain(res.status);
  });
});
