/**
 * Penetration Test: Injection (SQL/Command)
 */

import { describe, expect, it } from 'bun:test';

const API_BASE_URL = process.env.CALIBER_API_URL ?? 'http://localhost:3000';
const SKIP = process.env.SKIP_SECURITY_TESTS === 'true';

const SQL_PAYLOADS = [
  "' OR '1'='1",
  "'; DROP TABLE trajectories;--",
  '1; SELECT * FROM pg_tables;--',
];

const CMD_PAYLOADS = ['; ls -la', '| cat /etc/passwd', '$(whoami)'];

async function api(method: string, path: string, body?: unknown): Promise<Response> {
  const url = `${API_BASE_URL}${path}`;
  const options: RequestInit = {
    method,
    headers: { 'Content-Type': 'application/json' },
  };
  if (body) options.body = JSON.stringify(body);
  return fetch(url, options);
}

describe.skipIf(SKIP)('pentest: injection', () => {
  it('does not 500 on SQL injection payloads', async () => {
    for (const payload of SQL_PAYLOADS) {
      const res = await api('GET', `/api/v1/trajectories?name=${encodeURIComponent(payload)}`);
      expect(res.status).not.toBe(500);
    }
  });

  it('does not 500 on command injection payloads', async () => {
    for (const payload of CMD_PAYLOADS) {
      const res = await api('POST', '/api/v1/dsl/validate', { source: payload });
      expect(res.status).not.toBe(500);
    }
  });
});
