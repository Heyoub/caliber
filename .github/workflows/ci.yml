# CALIBER CI Pipeline (Optimized)
# ~15-20 min for PRs, full suite on main
#
# PR Jobs: lint, test-unit, test-ts, security, build
# Main Jobs: + test-integration, test-e2e, test-security
# Scheduled: test-load (nightly), test-mutation (weekly)

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    paths-ignore:
      - ".github/dependabot.yml"
      - ".github/workflows/dependabot-ci.yml"
  schedule:
    - cron: '0 2 * * *'   # Nightly load tests
    - cron: '0 3 * * 0'   # Weekly mutation tests
  workflow_dispatch:

permissions: read-all

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: short

jobs:
  # Skip full CI for Dependabot PRs
  dependabot-skip:
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
      - run: echo "Skipping full CI for Dependabot PRs"

  # =============================================================================
  # Docs Guard
  # =============================================================================
  docs-guard:
    name: Docs Guard
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Detect doc/code changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            docs:
              - README.md
              - CHANGELOG.md
              - DEVLOG.md
              - docs/**
            code:
              - '**/*'
              - '!README.md'
              - '!CHANGELOG.md'
              - '!DEVLOG.md'
              - '!docs/**'

      - name: Warn on PR
        if: github.event_name == 'pull_request' && steps.changes.outputs.code == 'true' && steps.changes.outputs.docs == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: 'Docs check: code changed but docs were not updated.',
            });

      - name: Fail on main
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && steps.changes.outputs.code == 'true' && steps.changes.outputs.docs == 'false'
        run: |
          echo "Docs required: code changed without updates to README/docs/CHANGELOG/DEVLOG."
          exit 1

  # =============================================================================
  # Fast Feedback (<5 min)
  # =============================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-rust
        with:
          components: rustfmt, clippy

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --workspace --exclude caliber-pg --all-targets --all-features -- -D warnings

      - name: Check unused dependencies
        run: |
          cargo install cargo-machete
          cargo machete || echo "::warning::Unused dependencies detected"

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.6"
      - run: bun install --frozen-lockfile
      - run: bunx biome check .

  # =============================================================================
  # Core Tests
  # =============================================================================
  test-unit:
    name: Test (Rust)
    runs-on: ubuntu-latest
    services:
      postgres:
        image: pgvector/pgvector:pg18
        env:
          POSTGRES_USER: caliber
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: caliber_test
        ports:
          - 5432:5432
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-rust
      - uses: taiki-e/install-action@cargo-llvm-cov
      - uses: taiki-e/install-action@nextest

      - name: Run tests with coverage
        env:
          CALIBER_DB_HOST: localhost
          CALIBER_DB_PORT: 5432
          CALIBER_DB_NAME: caliber_test
          CALIBER_DB_USER: caliber
          CALIBER_DB_PASSWORD: test_password
        run: |
          cargo llvm-cov --workspace --exclude caliber-pg --lcov --output-path lcov.info \
            --ignore-filename-regex '(caliber-pg|fuzz)' -- --test-threads=1

      - uses: codecov/codecov-action@v4
        with:
          files: lcov.info
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Check coverage regression
        run: |
          if [ -f .ci/coverage-baseline.txt ]; then
            python3 scripts/ci/coverage_check.py lcov.info .ci/coverage-baseline.txt
          else
            echo "No coverage baseline found, skipping regression check"
          fi

  # Consolidated TypeScript/JavaScript tests
  test-ts:
    name: Test (TypeScript)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.6"
      - run: bun install --frozen-lockfile

      - name: Run all TS tests
        run: |
          bun test ./tests/property/ || true
          bun test ./tests/fuzz/ || true
          bun test ./tests/chaos/ || true
          bun test ./tests/smoke/ || true
          bun test ./tests/component/ || true

  # =============================================================================
  # Security (Every PR)
  # =============================================================================
  security:
    name: Security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo install cargo-audit cargo-deny
      - run: cargo audit
      - run: cargo deny check

  # =============================================================================
  # Build
  # =============================================================================
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-rust

      - name: Build release
        run: cargo build --release -p caliber-api --features openapi,swagger-ui

      - uses: actions/upload-artifact@v4
        with:
          name: caliber-api
          path: target/release/caliber-api
          retention-days: 7

  # =============================================================================
  # PostgreSQL Extension
  # =============================================================================
  test-pg:
    name: Test (PostgreSQL)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-rust

      - name: Install PostgreSQL 18
        run: |
          sudo install -d /usr/share/postgresql-common/pgdg
          curl -fsSL https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo gpg --dearmor --batch --yes --no-tty -o /usr/share/postgresql-common/pgdg/apt.postgresql.org.gpg
          echo "deb [signed-by=/usr/share/postgresql-common/pgdg/apt.postgresql.org.gpg] http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" | sudo tee /etc/apt/sources.list.d/pgdg.list
          sudo apt-get update
          sudo apt-get install -y postgresql-18 postgresql-server-dev-18

      - name: Install cargo-pgrx
        run: cargo install cargo-pgrx --version 0.16.1 --locked

      - name: Initialize pgrx
        run: cargo pgrx init --pg18 /usr/lib/postgresql/18/bin/pg_config

      - name: Run caliber-pg tests
        run: cargo pgrx test pg18 --package caliber-pg --features pg_test

  # =============================================================================
  # Main Branch Only (Full Integration)
  # =============================================================================
  test-integration:
    name: Test (Integration)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'
    needs: [build]
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-rust
      - uses: taiki-e/install-action@nextest
      - uses: ./.github/actions/setup-pg18
        with:
          install-extension: 'true'

      - name: Run integration tests
        env:
          CALIBER_DB_HOST: localhost
          CALIBER_DB_PORT: ${{ env.PGPORT }}
          CALIBER_DB_NAME: caliber_test
          CALIBER_DB_USER: caliber
          CALIBER_DB_PASSWORD: test_password
          DB_TESTS: "1"
        run: cargo nextest run --workspace --exclude caliber-pg -E 'test(/db_backed/)' --test-threads=1

  test-e2e:
    name: Test (E2E)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [build]
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-rust
      - uses: ./.github/actions/setup-pg18
        with:
          install-extension: 'true'
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.6"
      - run: bun install --frozen-lockfile

      - uses: actions/download-artifact@v4
        with:
          name: caliber-api
      - run: chmod +x caliber-api

      - name: Start API server
        env:
          CALIBER_DB_HOST: localhost
          CALIBER_DB_PORT: ${{ env.PGPORT }}
          CALIBER_DB_NAME: caliber_test
          CALIBER_DB_USER: caliber
          CALIBER_DB_PASSWORD: test_password
          CALIBER_REDIS_URL: redis://localhost:6379
          CALIBER_API_PORT: 3000
          CALIBER_JWT_SECRET: test_secret_for_ci_only
          CALIBER_AUTH_PROVIDER: jwt
          CALIBER_REQUIRE_TENANT_HEADER: "true"
        run: |
          ./caliber-api &
          timeout 30 bash -c 'until curl -f http://localhost:3000/health 2>/dev/null; do sleep 1; done'

      - name: Create test tenant and JWT
        id: auth
        run: |
          TENANT_ID=$(PGPASSWORD=test_password psql -h localhost -p $PGPORT -U caliber -d caliber_test -Atqc "SELECT caliber_tenant_create('ci-tenant', NULL, NULL);")
          echo "tenant_id=$TENANT_ID" >> $GITHUB_OUTPUT

          node - <<'NODE'
          const crypto = require('crypto');
          const header = { alg: 'HS256', typ: 'JWT' };
          const now = Math.floor(Date.now() / 1000);
          const payload = { sub: 'ci-test', iat: now, exp: now + 3600, tenant_id: process.env.TENANT_ID };
          const b64url = (obj) => Buffer.from(JSON.stringify(obj)).toString('base64url');
          const data = `${b64url(header)}.${b64url(payload)}`;
          const sig = crypto.createHmac('sha256', 'test_secret_for_ci_only').update(data).digest('base64url');
          require('fs').appendFileSync(process.env.GITHUB_OUTPUT, `token=${data}.${sig}\n`);
          NODE
        env:
          TENANT_ID: ${{ steps.auth.outputs.tenant_id }}

      - name: Run E2E tests
        env:
          CALIBER_API_URL: http://localhost:3000
          CALIBER_TEST_TOKEN: ${{ steps.auth.outputs.token }}
          CALIBER_TEST_TENANT_ID: ${{ steps.auth.outputs.tenant_id }}
        run: bun test ./tests/e2e/

  test-security:
    name: Test (Security/OWASP)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [build]
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-rust
      - uses: ./.github/actions/setup-pg18
        with:
          install-extension: 'true'
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.6"
      - run: bun install --frozen-lockfile

      - uses: actions/download-artifact@v4
        with:
          name: caliber-api
      - run: chmod +x caliber-api

      - name: Start API server
        env:
          CALIBER_DB_HOST: localhost
          CALIBER_DB_PORT: ${{ env.PGPORT }}
          CALIBER_DB_NAME: caliber_test
          CALIBER_DB_USER: caliber
          CALIBER_DB_PASSWORD: test_password
          CALIBER_API_PORT: 3000
          CALIBER_JWT_SECRET: test_secret_for_ci_only
          CALIBER_AUTH_PROVIDER: jwt
          CALIBER_REQUIRE_TENANT_HEADER: "true"
        run: |
          ./caliber-api &
          timeout 30 bash -c 'until curl -f http://localhost:3000/health 2>/dev/null; do sleep 1; done'

      - name: Create test tenant and JWT
        id: auth
        run: |
          TENANT_ID=$(PGPASSWORD=test_password psql -h localhost -p $PGPORT -U caliber -d caliber_test -Atqc "SELECT caliber_tenant_create('ci-tenant', NULL, NULL);")
          echo "tenant_id=$TENANT_ID" >> $GITHUB_OUTPUT

          node - <<'NODE'
          const crypto = require('crypto');
          const header = { alg: 'HS256', typ: 'JWT' };
          const now = Math.floor(Date.now() / 1000);
          const payload = { sub: 'ci-test', iat: now, exp: now + 3600, tenant_id: process.env.TENANT_ID };
          const b64url = (obj) => Buffer.from(JSON.stringify(obj)).toString('base64url');
          const data = `${b64url(header)}.${b64url(payload)}`;
          const sig = crypto.createHmac('sha256', 'test_secret_for_ci_only').update(data).digest('base64url');
          require('fs').appendFileSync(process.env.GITHUB_OUTPUT, `token=${data}.${sig}\n`);
          NODE
        env:
          TENANT_ID: ${{ steps.auth.outputs.tenant_id }}

      - name: Run OWASP security tests
        env:
          CALIBER_API_URL: http://localhost:3000
          CALIBER_TEST_TOKEN: ${{ steps.auth.outputs.token }}
          CALIBER_TEST_TENANT_ID: ${{ steps.auth.outputs.tenant_id }}
        run: bun test ./tests/security/

  # =============================================================================
  # Scheduled Jobs
  # =============================================================================
  test-load:
    name: Test (Load)
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '0 2 * * *'
    needs: [build]
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-rust
      - uses: ./.github/actions/setup-pg18
        with:
          install-extension: 'true'

      - uses: actions/download-artifact@v4
        with:
          name: caliber-api
      - run: chmod +x caliber-api

      - name: Start API server
        env:
          CALIBER_DB_HOST: localhost
          CALIBER_DB_PORT: ${{ env.PGPORT }}
          CALIBER_DB_NAME: caliber_test
          CALIBER_DB_USER: caliber
          CALIBER_DB_PASSWORD: test_password
          CALIBER_REDIS_URL: redis://localhost:6379
          CALIBER_API_PORT: 3000
          CALIBER_JWT_SECRET: test_secret_for_ci_only
          CALIBER_AUTH_PROVIDER: jwt
        run: |
          ./caliber-api &
          timeout 30 bash -c 'until curl -f http://localhost:3000/health 2>/dev/null; do sleep 1; done'

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update && sudo apt-get install k6

      - name: Run load tests
        run: |
          k6 run tests/load/k6/api-baseline.js
          k6 run tests/load/k6/api-stress.js || true

  test-mutation:
    name: Test (Mutation)
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '0 3 * * 0'
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.6"
      - run: bun install --frozen-lockfile
      - run: bunx stryker run --reporters json,html
        continue-on-error: true
      - uses: actions/upload-artifact@v4
        with:
          name: mutation-report
          path: reports/mutation/
          retention-days: 30

  # =============================================================================
  # Dashboard Smoke (PR only)
  # =============================================================================
  dashboard-smoke:
    name: Test (Dashboard)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.6"
      - run: cd landing && bun install --frozen-lockfile
      - run: cd landing && bun x playwright install --with-deps chromium
      - run: cd landing && bunx playwright test --project=chromium
        env:
          CI: "1"
